---
- name: Check if rke2-server was previously installed
  ansible.builtin.set_fact:
    rke2_installed: true
  when:
    - ansible_facts.services["rke2-server.service"] is defined
    - ansible_facts.services["rke2-server.service"].status != 'disabled'
    - inventory_hostname in groups['rke2_servers']
    - install_method == "tarball"

- name: Check if rke2-server is running
  ansible.builtin.set_fact:
    rke2_running: true
  when:
    - ansible_facts.services["rke2-server.service"] is defined
    - ansible_facts.services["rke2-server.service"].state == 'running'
    - inventory_hostname in groups['rke2_servers']

- name: Check if rke2-agent was previously installed
  ansible.builtin.set_fact:
    rke2_installed: true
  when:
    - ansible_facts.services["rke2-agent.service"] is defined
    - ansible_facts.services["rke2-agent.service"].status != 'disabled'
    - inventory_hostname in groups.get('rke2_agents', [])
    - install_method == "tarball"

- name: Check if rke2-agent is running
  ansible.builtin.set_fact:
    rke2_running: true
  when:
    - ansible_facts.services["rke2-agent.service"] is defined
    - ansible_facts.services["rke2-agent.service"].state == 'running'
    - inventory_hostname in groups.get('rke2_agents', [])

- name: Check for RKE2 binary
  ansible.builtin.stat:
    path: "{{ rke2_tarball_install_dir }}/bin/rke2"
  register: rke2_binary
  when: install_method == "tarball"

- name: Get current RKE2 version
  ansible.builtin.command:
    cmd: "{{ rke2_tarball_install_dir }}/bin/rke2 --version"
  register: rke2_version_output
  changed_when: false
  failed_when: false
  when:
    - install_method == "tarball"
    - rke2_binary.stat.exists | default(false)

- name: Parse installed RKE2 version
  ansible.builtin.set_fact:
    rke2_installed_version: "{{ rke2_version_output.stdout | regex_search('rke2 version (v[0-9.]+\\+rke2r[0-9]+)', '\\1') | first | default('') }}"
  when:
    - install_method == "tarball"
    - rke2_binary.stat.exists | default(false)
    - rke2_version_output.rc == 0
