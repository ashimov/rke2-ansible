---
# =============================================================================
# Cluster Token Retrieval
# =============================================================================

- name: Wait for node token file
  ansible.builtin.wait_for:
    path: "{{ rke2_data_dir }}/server/node-token"
    timeout: "{{ rke2_api_wait_timeout }}"
  delegate_to: "{{ token_source_node }}"

- name: Validate token file is not empty
  ansible.builtin.stat:
    path: "{{ rke2_data_dir }}/server/node-token"
  register: _token_file
  delegate_to: "{{ token_source_node }}"
  failed_when: not _token_file.stat.exists or _token_file.stat.size == 0

- name: Read node token from server
  ansible.builtin.slurp:
    src: "{{ rke2_data_dir }}/server/node-token"
  register: _node_token
  delegate_to: "{{ token_source_node }}"
  no_log: true

- name: Store node token
  ansible.builtin.set_fact:
    rke2_config_token: "{{ _node_token.content | b64decode | trim }}"
  delegate_to: "{{ token_source_node }}"
  no_log: true

- name: Add token to host configuration
  ansible.builtin.set_fact:
    host_rke2_config: >-
      {{ {'token': rke2_config_token}
         | ansible.builtin.combine(host_rke2_config | default({}), list_merge='prepend_rp') }}
  no_log: true

- name: Set API server host if not defined
  ansible.builtin.set_fact:
    rke2_kubernetes_api_server_host: "{{ token_source_node }}"
  when: rke2_kubernetes_api_server_host == ""

- name: Add server URL to host configuration
  ansible.builtin.set_fact:
    host_rke2_config: >-
      {{ {'server': 'https://' + rke2_kubernetes_api_server_host + ':' + (rke2_supervisor_port | string)}
         | ansible.builtin.combine(host_rke2_config | default({}), list_merge='prepend_rp') }}
